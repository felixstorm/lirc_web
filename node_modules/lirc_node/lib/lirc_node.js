exports.version = '0.0.2';
exports.IRSend = require('./irsend');
exports.irsend = new exports.IRSend();

exports.init = function(callback) {
    exports.irsend.list('', '', function (error, stdout, stderr) {
        exports._populateRemotes(error, stdout, stderr);
        exports._populateCommands(callback);
    });
};


// Private
exports._populateRemotes = function(error, stdout, stderr) {
    exports.remotes = {};
    stderr.split('\n').forEach(function(element, index, array) {
        var remoteName = element.match(/\s(.*)$/);
        if (remoteName)
            exports.remotes[remoteName[1]] = [];
    });
};

exports._populateCommands = function(callback) {
    var remotesCount = Object.keys(exports.remotes).length;
    for (var remote in exports.remotes) {
        exports.irsend.list(remote, '', function(error, stdout, stderr) {
            exports._populateRemoteCommands(remote, error, stdout, stderr);
            remotesCount--;
            if (callback && remotesCount == 0)
                callback();
        });
    }
};

exports._populateRemoteCommands = function(remote, error, stdout, stderr) {
    stderr.split('\n').forEach(function(element, index, array) {
        var commandName = element.match(/\s.*\s(.*)$/);
        if (commandName && commandName[1])
            exports.remotes[remote].push(commandName[1]);
    });
};
